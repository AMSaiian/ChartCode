<div class="w-full h-full overflow-auto">
  <!-- 1. Забираем сразу и nodes, и edges -->
  <ng-container *ngIf="elements$ | async as elements">

    <svg [attr.width]="1920" [attr.height]="2000" style="border:1px solid #ccc">
      <!-- 2. Определяем маркер стрелки -->
      <defs>
        <marker id="arrow" markerWidth="6" markerHeight="6"
                refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L6,3 L0,6 Z" fill="black"/>
        </marker>
      </defs>

      <!-- 3. Рисуем сначала все линии -->
      <ng-container *ngFor="let e of elements.edges">
        <path
          [attr.d]="e.path"
          stroke="black"
          fill="none"
          [attr.marker-end]="!e.isSupport ? 'url(#arrow)' : null" />
      </ng-container>

      <!-- 4. А потом поверх линии — узлы -->
      <ng-container *ngFor="let node of elements.nodes">
        <g [attr.transform]="'translate(' + node.x + ',' + node.y + ')'">
          <!-- Терминал -->
          <ellipse *ngIf="node.element | instanceOf: TerminalElement"
                   [attr.cx]="120/2" [attr.cy]="60/2"
                   [attr.rx]="120/2" [attr.ry]="60/2"
                   fill="#d1e7dd" stroke="#0f5132" stroke-width="2" />

          <!-- Условие -->
          <polygon *ngIf="node.element | instanceOf: ConditionElement"
                   [attr.points]="getConditionPoints(120, 60)"
                   fill="#fff3cd" stroke="#664d03" stroke-width="2" />

          <rect *ngIf="node.element | instanceOf: ForLoopElement"
                [attr.width]="120"
                [attr.height]="60"
                fill="#FAA0A0"
                stroke="#880808"
                stroke-width="2" />

          <!-- Всё остальное -->
          <rect *ngIf="!((node.element | instanceOf: TerminalElement)
                         || (node.element | instanceOf: ConditionElement)
                         || (node.element | instanceOf: ProcedureElement)
                         || (node.element | instanceOf: ForLoopElement))"
                [attr.width]="120"
                [attr.height]="60"
                fill="#cff4fc"
                stroke="#055160"
                stroke-width="2" />

          <text
            [attr.x]="120/2"
            [attr.y]="60/2"
            text-anchor="middle"
            dominant-baseline="central"
            font-family="Arial"
            font-size="12">
            {{ node.element.id.slice(0, 8) }}
          </text>
        </g>
      </ng-container>

      <g *ngFor="let point of elements.insertions" [attr.transform]="'translate(' + point.x + ',' + point.y + ')'">
        <circle
          cx="0" cy="0" r="4"
          fill="red"
          stroke="black"
          stroke-width="1"
        />
      </g>
    </svg>
  </ng-container>
</div>
